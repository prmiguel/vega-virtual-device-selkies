#!/bin/bash

function start_simulator {
    echo "Start Simulator"
    kepler device simulator start || true
}

function wait_until_simulator_is_running {
    echo "Wait until Simulator is running"
    while  [ "$(kepler device simulator status | jq -r .running)" != "true" ]; do echo "Simulator is not running"; sleep 2; done
    echo "Simulator is running"
}

function wait_until_simulator_is_connected {
    echo "Wait until Simulator is connected"
    while  [ "$(kepler device is-connected -d Simulator)" != "Device Simulator is connected" ]; do echo "Device Simulator is not connected"; sleep 5; done
    echo "Device Simulator is connected"
}

function close_popup {
    echo "Close popup"
    wmctrl -c "Emulator Running in Nested Virtualization"
}

function install_app {
    echo "Install App"
    kepler device install-app -d Simulator -p $PACKAGE_PATH
}

function run_app {
    echo "Run App"
    kepler device launch-app -d Simulator -a $APP_NAME
}

kepler --version
start_simulator
close_popup
wait_until_simulator_is_running
close_popup
wait_until_simulator_is_connected
close_popup
kepler device run-cmd -d Simulator --command 'touch /tmp/automation-toolkit.enable'
kepler device uninstall-app -a com.amazon.keplerlauncherapp.main
install_app
run_app
